generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model BotInstance {
  id                 String         @id @default(cuid())
  userWalletAddress  String         @unique
  userSubaccount     String
  capitalUSDC        Float
  volumeTargetUSDC   Float
  bias               String
  strategy           String         @default("twap")
  market             String
  marketName         String
  isRunning          Boolean        @default(true)
  cumulativeVolume   Float          @default(0)
  ordersPlaced       Int            @default(0)
  currentCapitalUsed Float          @default(0)
  lastOrderTime      DateTime?
  error              String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  sessionId          String?
  lastTwapOrderTime  DateTime?
  // High-risk strategy position tracking (so bot doesn't interfere with manual trades)
  activePositionSize    Float?     // Size of position opened by bot (null = no bot position)
  activePositionIsLong  Boolean?   // Direction of bot's position
  activePositionEntry   Float?     // Entry price of bot's position
  activePositionTxHash  String?    // Tx hash that opened the position
  orders             OrderHistory[]
}

model OrderHistory {
  id              String      @id @default(cuid())
  botId           String
  timestamp       DateTime    @default(now())
  txHash          String
  direction       String
  strategy        String      @default("twap")
  size            BigInt      // Changed from Int - contract sizes can exceed 2^31
  volumeGenerated Float
  success         Boolean
  entryPrice      Float?
  exitPrice       Float?
  pnl             Float       @default(0)
  positionHeldMs  Int         @default(0)
  sessionId       String?
  market          String?     // Market name (e.g., "BTC/USD")
  leverage        Int?        // Leverage used for this trade
  bot             BotInstance @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([botId])
  @@index([sessionId])
}
