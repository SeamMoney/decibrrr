# Implementation Plan: Multiple Trading Strategies for Volume Bot

## Overview
Implement 3 new trading strategies beyond the existing TWAP strategy to give users more control over risk/reward profiles and PNL volatility.

## Current State Analysis

### What Works
- ✅ TWAP strategy using `place_twap_order_to_subaccount` (passive limit orders)
- ✅ Database persistence with Prisma (bot state, order history)
- ✅ Bot delegation system (bot operator can trade on behalf of users)
- ✅ UI with strategy selector showing 4 options: TWAP, Market Maker, Delta Neutral, High Risk
- ✅ Order history table displaying trades

### Available Order Functions (from Decibel DEX)
1. **`place_twap_order_to_subaccount`** - Currently used for TWAP strategy
   - Parameters: subaccount, market, size, is_buy, reduce_only, min_duration, max_duration
   - Creates passive limit orders that execute over time
   - Low PNL impact (orders may not fill)

2. **`place_market_order_to_subaccount`** - For immediate execution
   - Parameters: subaccount, market, size, is_buy, reduce_only, client_order_id, limit_price, take_profit_price, stop_loss_price, trigger_price, max_leverage, builder_address, max_builder_fee
   - Executes immediately at market price
   - High PNL impact (guaranteed fills)

3. **`place_order_to_subaccount`** - Standard limit order
   - Parameters: subaccount, market, size, price, is_buy, time_in_force, post_only, client_order_id, limit_price, take_profit_price, stop_loss_price, trigger_price, max_leverage, builder_address, max_builder_fee
   - Places limit order at specific price
   - Medium PNL impact

4. **`place_bulk_orders_to_subaccount`** - Multiple orders at once
   - Parameters: subaccount, market, order_type, sizes[], prices[], is_buys[], time_in_forces[]
   - Efficient for market making strategies

## Strategy Implementations

### 1. Market Maker Strategy (Aggressive - Active PNL)
**Goal**: Use market orders for immediate execution and frequent position changes

**Approach**:
- Use `place_market_order_to_subaccount` for instant fills
- Alternate between long/short positions every 1-2 minutes
- Use larger position sizes (5-10% of capital per trade)
- Each trade executes immediately, causing PNL to fluctuate
- Capital efficiency: Lower (market orders have slippage)
- Risk: Medium-High (immediate exposure to market movements)

**Implementation**:
```typescript
private async placeMarketMakerOrder(size: number, isLong: boolean): Promise<OrderResult> {
  const transaction = await this.aptos.transaction.build.simple({
    sender: this.botAccount.accountAddress,
    data: {
      function: `${DECIBEL_PACKAGE}::dex_accounts::place_market_order_to_subaccount`,
      typeArguments: [],
      functionArguments: [
        this.config.userSubaccount,
        this.config.market,
        contractSize,
        isLong,
        false,      // reduce_only
        undefined,  // client_order_id
        undefined,  // limit_price (use market price)
        undefined,  // take_profit_price
        undefined,  // stop_loss_price
        undefined,  // trigger_price
        undefined,  // max_leverage
        undefined,  // builder_address
        undefined,  // max_builder_fee
      ],
    },
  })
  // ... sign and submit
}
```

**Key Differences from TWAP**:
- Orders execute immediately (not over time)
- Guaranteed fills mean guaranteed PNL changes
- Faster execution interval (1-2 min vs 2 min)
- Larger position sizes

---

### 2. Delta Neutral Strategy (Hedged Positions - Minimal Risk)
**Goal**: Open positions and immediately hedge them to minimize directional risk

**Approach**:
- Open a long position
- Immediately open an equal-sized short position
- Result: Net position = 0, but volume generated = 2x
- Use `place_order_to_subaccount` with post-only for better pricing
- This generates volume without taking directional risk
- PNL fluctuates minimally (only from funding rates and fees)

**Implementation**:
```typescript
private async placeDeltaNeutralOrders(size: number): Promise<OrderResult[]> {
  // Get current market price from API
  const marketPrice = await this.getCurrentMarketPrice()

  // Place long limit order slightly above market
  const longOrder = await this.placeLimitOrder(size, true, marketPrice * 1.0001)

  // Place short limit order slightly below market
  const shortOrder = await this.placeLimitOrder(size, false, marketPrice * 0.9999)

  // Return both results
  return [longOrder, shortOrder]
}

private async placeLimitOrder(size: number, isLong: boolean, price: number): Promise<OrderResult> {
  const transaction = await this.aptos.transaction.build.simple({
    sender: this.botAccount.accountAddress,
    data: {
      function: `${DECIBEL_PACKAGE}::dex_accounts::place_order_to_subaccount`,
      typeArguments: [],
      functionArguments: [
        this.config.userSubaccount,
        this.config.market,
        contractSize,
        priceInContractFormat,
        isLong,
        0,         // time_in_force: GTC (Good Till Cancel)
        true,      // post_only: true for better fees
        undefined, // client_order_id
        undefined, // limit_price (this IS the limit price)
        undefined, // take_profit_price
        undefined, // stop_loss_price
        undefined, // trigger_price
        undefined, // max_leverage
        undefined, // builder_address
        undefined, // max_builder_fee
      ],
    },
  })
  // ... sign and submit
}
```

**Key Differences from TWAP**:
- Opens TWO positions per cycle (long + short)
- Net delta = 0 (hedged)
- Volume doubled (both trades count)
- Minimal PNL fluctuation (only fees/funding)

---

### 3. High Risk Strategy (Maximum PNL Volatility)
**Goal**: Maximize PNL swings by using leverage and large positions

**Approach**:
- Use `place_market_order_to_subaccount` with leverage
- Open large positions (20-50% of capital)
- Do NOT immediately close positions - let them run for 5-10 minutes
- Only close when switching direction (bias changes)
- Use `max_leverage` parameter to amplify position size
- This creates maximum exposure to market movements

**Implementation**:
```typescript
private async placeHighRiskOrder(size: number, isLong: boolean): Promise<OrderResult> {
  // Calculate leverage (2x-5x depending on capital)
  const leverage = this.calculateLeverage()

  const transaction = await this.aptos.transaction.build.simple({
    sender: this.botAccount.accountAddress,
    data: {
      function: `${DECIBEL_PACKAGE}::dex_accounts::place_market_order_to_subaccount`,
      typeArguments: [],
      functionArguments: [
        this.config.userSubaccount,
        this.config.market,
        contractSize * leverage,  // Larger size with leverage
        isLong,
        false,      // reduce_only
        undefined,  // client_order_id
        undefined,  // limit_price
        undefined,  // take_profit_price
        undefined,  // stop_loss_price
        undefined,  // trigger_price
        leverage,   // max_leverage: 2-5x
        undefined,  // builder_address
        undefined,  // max_builder_fee
      ],
    },
  })
  // ... sign and submit
}

private calculateLeverage(): number {
  const { capitalUSDC } = this.config
  // More capital = higher leverage (but cap at 5x)
  if (capitalUSDC >= 1000) return 5
  if (capitalUSDC >= 500) return 3
  return 2
}
```

**Key Differences from TWAP**:
- Uses leverage (2-5x)
- Larger position sizes (20-50% of capital)
- Positions held longer (5-10 min vs immediate close)
- Market orders (guaranteed fills, instant PNL impact)
- Maximum exposure to price movements

---

## Implementation Steps

### Step 1: Add Strategy Parameter to Config
**File**: `lib/bot-engine.ts`

```typescript
export interface BotConfig {
  userWalletAddress: string
  userSubaccount: string
  capitalUSDC: number
  volumeTargetUSDC: number
  bias: 'long' | 'short' | 'neutral'
  market: string
  marketName: string
  strategy: 'twap' | 'market_maker' | 'delta_neutral' | 'high_risk'  // ADD THIS
}
```

### Step 2: Add Market Price Fetcher
**File**: `lib/bot-engine.ts`

```typescript
private async getCurrentMarketPrice(): Promise<number> {
  try {
    const response = await fetch('https://api.netna.aptoslabs.com/decibel/api/v1/market_prices')
    const markets = await response.json()

    // Find our market
    const marketData = markets.find((m: any) => m.market === this.config.market)
    if (!marketData) {
      throw new Error(`Market ${this.config.market} not found`)
    }

    return parseFloat(marketData.mark_price)
  } catch (error) {
    console.error('Failed to fetch market price:', error)
    // Fallback to hardcoded price
    return 100000 // BTC default
  }
}
```

### Step 3: Implement Order Placement Methods
**File**: `lib/bot-engine.ts`

Add three new methods:
1. `placeMarketMakerOrder()` - Market orders for immediate execution
2. `placeDeltaNeutralOrders()` - Paired long/short limit orders
3. `placeHighRiskOrder()` - Leveraged market orders

### Step 4: Update Main Loop
**File**: `lib/bot-engine.ts`

```typescript
private async runLoop() {
  const { strategy } = this.config

  // Calculate order size
  const orderSize = this.calculateOrderSize()
  if (orderSize === 0) {
    this.stop()
    return
  }

  const direction = this.getNextDirection()
  const isLong = direction === 'long'

  let result: OrderResult

  // Route to appropriate strategy
  switch (strategy) {
    case 'twap':
      result = await this.placeOrder(orderSize, isLong)
      break

    case 'market_maker':
      result = await this.placeMarketMakerOrder(orderSize, isLong)
      break

    case 'delta_neutral':
      // Returns array, but we'll handle it
      const results = await this.placeDeltaNeutralOrders(orderSize)
      result = this.combineResults(results)
      break

    case 'high_risk':
      result = await this.placeHighRiskOrder(orderSize, isLong)
      break

    default:
      result = await this.placeOrder(orderSize, isLong)
  }

  // Rest of loop continues...
}
```

### Step 5: Update UI to Pass Strategy
**File**: `app/api/bot/start/route.ts`

```typescript
const {
  userWalletAddress,
  userSubaccount,
  capitalUSDC,
  volumeTargetUSDC,
  bias,
  market,
  marketName,
  strategy,  // ADD THIS
} = body as BotConfig
```

**File**: `components/bot/server-bot-config.tsx`

```typescript
// In handleStart function, add strategy to request body:
body: JSON.stringify({
  userWalletAddress: account.address.toString(),
  userSubaccount: subaccount,
  capitalUSDC: capitalNum,
  volumeTargetUSDC: volumeTarget,
  bias,
  market: "0xf50add10e6982e3953d9d5bec945506c3ac049c79b375222131704d25251530e",
  marketName: "BTC/USD",
  strategy,  // ADD THIS
}),
```

### Step 6: Update Database Schema
**File**: `prisma/schema.prisma`

```prisma
model BotInstance {
  id                String   @id @default(cuid())
  userWalletAddress String   @unique
  userSubaccount    String
  capitalUSDC       Float
  volumeTargetUSDC  Float
  bias              String   // 'long' | 'short' | 'neutral'
  strategy          String   @default("twap")  // ADD THIS
  market            String
  marketName        String
  isRunning         Boolean  @default(false)
  cumulativeVolume  Float    @default(0)
  ordersPlaced      Int      @default(0)
  currentCapitalUsed Float   @default(0)
  lastOrderTime     DateTime?
  error             String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  orders            OrderHistory[]
}
```

Then run: `npx prisma migrate dev --name add_strategy_field`

### Step 7: Adjust Execution Intervals
Different strategies need different timing:

- TWAP: 2 minutes (current)
- Market Maker: 1 minute (faster churn)
- Delta Neutral: 3 minutes (need time for both orders to fill)
- High Risk: 5 minutes (let positions run)

```typescript
async start(): Promise<void> {
  // ... existing code ...

  // Determine interval based on strategy
  const intervalMs = this.getStrategyInterval()

  this.loopInterval = setInterval(() => {
    if (this.isActive) {
      this.runLoop()
    }
  }, intervalMs)
}

private getStrategyInterval(): number {
  const { strategy } = this.config

  switch (strategy) {
    case 'market_maker': return 60_000   // 1 min
    case 'delta_neutral': return 180_000 // 3 min
    case 'high_risk': return 300_000     // 5 min
    case 'twap':
    default: return 120_000              // 2 min
  }
}
```

---

## Risk Considerations

### Market Maker Strategy
- **Risk**: Medium-High
- **Concern**: Slippage on market orders
- **Mitigation**: Use smaller position sizes initially (5% of capital)

### Delta Neutral Strategy
- **Risk**: Low
- **Concern**: Orders may not fill simultaneously (execution risk)
- **Mitigation**: Use limit orders close to market price, accept partial fills

### High Risk Strategy
- **Risk**: Very High
- **Concern**: Leverage can amplify losses
- **Mitigation**:
  - Start with low leverage (2x)
  - Cap maximum position size at 50% of capital
  - Monitor liquidation risk
  - Add warning in UI about risk

---

## Testing Plan

### Phase 1: Market Maker Strategy
1. Implement market order placement
2. Test with small capital ($10)
3. Verify orders execute immediately
4. Check PNL changes in UI

### Phase 2: Delta Neutral Strategy
1. Implement paired order placement
2. Test hedging mechanism
3. Verify net position = 0
4. Check volume generation

### Phase 3: High Risk Strategy
1. Implement leverage calculation
2. Test with very small capital ($5)
3. Monitor liquidation risk
4. Verify PNL volatility

### Phase 4: Integration
1. Test strategy switching
2. Verify database persistence
3. Test bot restart with different strategies
4. Load test with multiple concurrent bots

---

## Expected Outcomes

### TWAP (Existing)
- PNL Impact: Very Low (orders may not fill)
- Volume: Moderate (depends on fills)
- Capital Efficiency: High
- User Experience: "My balance isn't changing"

### Market Maker
- PNL Impact: **High** (all orders fill immediately)
- Volume: High (guaranteed fills)
- Capital Efficiency: Medium (slippage)
- User Experience: "My PNL is changing every minute!"

### Delta Neutral
- PNL Impact: Very Low (hedged)
- Volume: **Very High** (2x orders)
- Capital Efficiency: High (no directional risk)
- User Experience: "Lots of volume, minimal risk"

### High Risk
- PNL Impact: **Very High** (leverage + market orders)
- Volume: Very High (large positions)
- Capital Efficiency: Low (high collateral)
- User Experience: "My PNL is swinging wildly!"

---

## Summary

This plan provides 3 new strategies that give users:
1. **More PNL volatility** (Market Maker, High Risk)
2. **Safer volume generation** (Delta Neutral)
3. **Different risk/reward profiles** for different goals

The implementation is modular and builds on the existing TWAP infrastructure. Each strategy uses different Decibel DEX functions discovered from the smart contract ABI.
